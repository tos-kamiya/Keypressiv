<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="css/html5reset.css">
        <link rel="stylesheet" href="css/fontsettings.css">
        <link rel="stylesheet" href="css/animation.css">
        <script src="js/jquery.min.js"></script>
        <script src="js/flowtype-mod.js"></script>
        <script src="js/jquery.hammer.min.js"></script>
        <script src="js/animation.js"></script>
        <script src="brython/brython.js"></script>
        <script type="text/javascript">
            var aspectRatio = 1.33;
            var columns = 4;
            var resizeElements = function() {
                $('bodyp').width($(window).width()).height($(window).height());
                $('#zone0').flowtype({ "aspactRatio": aspectRatio });
                $('#zone1').flowtype({ "aspactRatio": aspectRatio });
                $('#slidefooter-page,#slidefooter-text').flowtype({ "onlyFontResizing": true, "aspactRatio": aspectRatio });
                
                var scaling = 1.0 / columns;
                var elaw = $(window).width() - (5 * (columns * 2) + 2 * (columns + 1));
                $('.minimap-page').css({ "width": elaw * scaling + "px", "height": elaw * scaling / aspectRatio + "px" });
                $('.minimap-page').flowtype({ "onlyFontResizing": true, "scaling": scaling, "aspectRatio": null });
            };
            var changeAspectRatio = function(newRatio) {
                aspectRatio = newRatio;
                resizeElements();
            };
            $(function() {
                brython();
                resizeElements();
                $(window).resize(function(){ resizeElements(); });
            });

            var switchToSlideMode = function(i) {
                $('#bodyp').fadeIn("fast");
                $('#bodym').css('display', 'none');
                $("body").css("overflow", "hidden");
                resizeElements();
                if (i !== undefined)
                    goto_page(i);
            };
            var switchToMapMode = function() {
                $('#bodyp').css('display', 'none');
                $('#bodym').fadeIn("fast");
                $("body").css("overflow", "scroll");
                resizeElements();
            };
            var getCurMode = function() {
                if ($('#bodyp').css('display') != "none")
                    return "p";
                if ($('#bodym').css('display') != "none")
                    return "m";
                return "";
            };
            var bindHashchange = function(handler) {
	            $(window).on('hashchange', handler);
            };
            
            $("body").hammer({ "swipe_velocity": 0.5 })
                    .on("release swipeleft swiperight", function(ev) {
                switch(ev.type) {
                case 'swipeleft':
                    move_page(1);
                    ev.gesture.stopDetect();
                    break;
               case 'swiperight':
                    move_page(-1);
                    ev.gesture.stopDetect();
                    break;
                }
            });
        </script>
        <style>
            #zone0, #zone1 {
                position: absolute;
            }
            div#slidefooter-page {
                position: fixed;
                bottom: 0;
                z-index: -2;
            }
            div#slidefooter-text {
                position: fixed;
                bottom: 0;
                z-index: -2;
            }
        </style>

        <style>
            #zone > table, #zone > table > tbody > tr, #zone > table > tbody > tr > td {
                margin: 0;
                padding: 0;
            }
            #zone > table {
                table-layout:fixed;
                border-collapse: collapse;
            }
            .minimap-page {
                overflow: hidden;
            }
            #zone > table > tbody >  tr > td {
                padding: 5px;
                border: 2px solid #57bade;
            }
            #zone > table > tbody > tr > td:hover {
                background-color: #57bade;
            }
            #zone > table > tbody >  tr > td.empty-page {
                background-color: #888;
                border: 2px solid #888;
            }
            #zone > table > tbody >  tr > td.prev-shown-page {
                background-color: #e6aeae;
            }
            #zone > table > tbody >  tr > td.prev-shown-page:hover {
                background-color: #57bade;
            }
        </style>

        <!-- Optional: google-code-prettify, a syntax highlighter -->
        <link href="google-code-prettify/prettify.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="google-code-prettify/prettify.js"></script>
        <script>
            var doCodePrettify = true;
        </script>

        <!-- Optional: title of slide -->
        <title></title>
    </head>
    <body style="position:relative;overflow:hidden;">
        <div id="bodyp">
            <div id="slidefooter-page"></div>
            <div id="slidefooter-text"></div>
            <div id='zone0'>
            </div>
            <div id='zone1' style="display:none;">
            </div>
        </div>
        <div id="bodym" style="display:none;">
            <div id='zone'>
            </div>
        </div>
        <script type="text/python">
            from slidelib import read_pages, draw_slide, draw_minimap

            def get_hash():
                if doc.location.hash:
                    h = doc.location.hash[1:]
                    return h
                return None

            def set_hash_num(n):
                doc.location.hash = n

            # load presentation
            pages, config_data = read_pages("presentation.md")
            doc["slidefooter-text"].text = config_data.get("footer-text", "")
            a = config_data.get("aspect-ratio")
            if a:
                changeAspectRatio(a)

            # get initial page number
            h = get_hash()
            try:
                i = max(0, min(int(h) - 1, len(pages) - 1))
            except:
                i = 0
            cur_page_index = [i]

            # show a slide
            cur_zone_index = [0]
            i = cur_page_index[0]
            config_data.update({ "page": i + 1 })
            draw_slide(doc, 'zone%d' % cur_zone_index[0], pages[i], config_data)
            draw_minimap(doc, 'zone', pages, config_data)
            prettyPrint() # optional, google-code-prettify
            set_hash_num(i + 1)

            # page change functions
            def move_page(delta):
                if delta == 0:
                    return
                previ = i = cur_page_index[0]
                i += delta
                i = max(0, min(i, len(pages) - 1))
                if i == previ:
                    return
                config_data.update({ "page": i + 1 })
                zi = (cur_zone_index[0] + 1) % 2
                czid = 'zone%d' % cur_zone_index[0]
                nzid = 'zone%d' % zi
                draw_slide(doc, nzid, pages[i], config_data)
                if getCurMode() == "p" and -1 <= delta <= 1:
                    set_sliding_animation(nzid, czid, ("right" if delta > 0 else "left"))
                else:
                    set_no_animation(nzid, czid)
                prettyPrint() # optional, google-code-prettify
                cur_page_index[0] = i
                cur_zone_index[0] = zi
                set_hash_num(i + 1)
            
            def goto_page(n):
                move_page(n - cur_page_index[0])

            # keyboard handling
            cur_typing_string = []

            def do_keydown(e):
                kc = e.keyCode
                if 48 <= kc <= 105:
                    if 48 <= kc <= 57:  # digit
                        cur_typing_string.append(chr(ord('0') + (kc - 48)))
                    elif 96 <= kc <= 105:  # digit
                        cur_typing_string.append(chr(ord('0') + (kc - 96)))
                    elif 65 <= kc <= 90:  # A..Z
                        cur_typing_string.append(chr(kc - 65  + 97))
                    else:
                        cur_typing_string[:] = []
                        return False
                elif kc == 13:  # enter
                    s = "".join(cur_typing_string)
                    cur_typing_string[:] = []
                    if s == "s":
                        switchToSlideMode()
                    elif s == "m":
                        switchToMapMode()
                    else:
                        try:
                            n = int(s)
                        except:
                            return False
                        if n > 0:
                            i = n - 1
                            s = len(pages)
                            i = max(0, min(i, s - 1))
                            if getCurMode() != "s":
                                switchToSlideMode()
                            goto_page(i)
                        else:
                            return False
                else:
                    cur_typing_string[:] = []
                    if 37 <= kc <= 40:  # arrow keys
                        if getCurMode() == "p":
                            move_page(-1 if kc in (37, 38) else 1)
                    elif kc == 9:  # Tab
                        switchToMapMode()
                    elif kc == 27:  # Esc
                        switchToSlideMode()
                    else:
                        return False
                return True  # consume event

            doc.bind('keydown', do_keydown)

            # hash handling
            def do_hashchange(newUrl, oldUrl):
                h = get_hash()
                if h.startswith("s"):
                    switchToSlideMode()
                elif h.startswith("m"):
                    switchToMapMode()
                else:
                    try:
                        i = max(0, min(int(h) - 1, len(pages) - 1))
                        goto_page(i)
                    except:
                        pass

            bindHashchange(do_hashchange)
        </script>
    </body>
</html>

